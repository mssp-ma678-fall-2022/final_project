---
title: "midterm_project"
output: html_document
date: "2022-11-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(magrittr)
library(ggplot2)
library(lme4)
library(rstanarm)
```

## Read data
 

get the data from Kaggle: <https://www.kaggle.com/code/deetisood/dataset-for-jobs/data> dataset for jobs

```{r}
job <- read.csv("eda_data.csv")
salary <- read.csv("salary_data_cleaned.csv")
```

```{r}
test1 <- job %>% mutate(python=ifelse(str_detect(job$Job.Description,regex("python", ignore_case = T)),1,0))
test1 %<>% mutate(diff=python_yn-python)
sum(test1$diff)

test1 <- test1 %>% mutate(R=ifelse(grepl("language[^\\.!?]*R", Job.Description),1,0))
test1 %>% mutate(diff1=R_yn-R)

test1 <- test1 %>% mutate(aws_1=ifelse(str_detect(job$Job.Description,regex("AWS", ignore_case = F)),1,0))
test1 <- test1 %>% mutate(spark_1=ifelse(str_detect(job$Job.Description,regex("spark", ignore_case = T)),1,0))
test1 <- test1 %>% mutate(excel_1=ifelse(str_detect(job$Job.Description,regex("excel", ignore_case = T)),1,0))

test1 <- test1 %>% mutate(seniority_1=ifelse(str_detect(job$Job.Title,regex("senior", ignore_case = T)),1,0))

```

Larger dataset, <https://www.kaggle.com/datasets/josephgutstadt/data-jobs>

```{r}
all_jobs <- read.csv("all_jobs.csv")
```

I got this data from the Kaggle site that contains data science related jobs posting on the Glassdoor website. It gives job descriptions, companies information and the estimated salary range. I would like to find out the reason behind different salaries with different companies. That is to say, I wonder how the location, the company background and the requirement for job applicant affect the predictive salary in data science related jobs. If I can build a model based on the information in this datasets. Individuals then are able to get a sense of the estimated salary paying for their skills and preferred working locations, etc.

Most information is contained in the job descriptions. So I would like to get key words from the job descriptions posted by companies. The first thing I did is to search for required or recommended skills for the job applicants. For data science related works, it is reasonable to assume some kind of programming languages, such as Python, R, and SQL. At the same time, some popular tools such as spark, excel and AWS. These keywords are valued as 1 if it's contained in the job description; otherwise, it's 0. As a result, we got columns consist of 0s and 1s for each keywords, which then can be used as predictors in the regression model.

## Data cleaning

```{r}
## search if language and R are in the same sentence
all_jobs %<>% mutate(R=ifelse(grepl("language[^\\.!?]*R", Job.Description),1,0))

## search for all kinds of keywords 
all_jobs %<>% mutate(python=ifelse(str_detect(all_jobs$Job.Description,regex("python", ignore_case = T)),1,0))
all_jobs %<>% mutate(aws=ifelse(str_detect(all_jobs$Job.Description,regex("AWS", ignore_case = F)),1,0))
all_jobs %<>% mutate(sql=ifelse(str_detect(all_jobs$Job.Description,regex("SQL", ignore_case = F)),1,0))
all_jobs %<>% mutate(spark=ifelse(str_detect(all_jobs$Job.Description,regex("spark", ignore_case = T)),1,0))
all_jobs %<>% mutate(excel=ifelse(str_detect(all_jobs$Job.Description,regex("excel", ignore_case = T)),1,0))
all_jobs %<>% mutate(seniority=ifelse(str_detect(all_jobs$Job.Title,regex("senior", ignore_case = T)),1,0))

```

We need to clean the Job Estimated Salary column. The original column is a string that contain the range of predicted salary. So we first extract the two ends of the salary range. Then, I planned to take the average on the estimated salary and use it as the outcome of the regression model; and set the other columns as the predictors. Observed that there are -1 values in these columns, I mutate these values to Unknown or Not Applicable by examining the classifications. 

```{r}
## clean the string estimated salary column
all_jobs %<>% separate(Salary.Estimate, c("bottom", "top"), sep = "-")
regexp <- "[[:digit:]]+"
all_jobs %<>% mutate(bottom = as.numeric(str_extract(bottom, regexp)))
all_jobs %<>% mutate(top = as.numeric(str_extract(top, regexp)))
all_jobs %<>% mutate(median=(bottom+top)/2, .before=top)

## set -1 to unknown in company size
all_jobs %<>% mutate(Size=ifelse(Size==-1,"Unknown",Size))

## set -1 to Unknown / Non-Applicable in company revenue
all_jobs %<>% mutate(Revenue=ifelse(Revenue==-1,"Unknown / Non-Applicable",Revenue))


all_jobs %>% mutate(Company.Name=ifelse(Company.Name=="", "Not Applicable",Company.Name))

```

## EDA

Since our goal is to see if the predictors that have an effect on the median outcome of the data related job post, I  would like to get a glimpse at the distribution of the median income. And on the graph below, we can see most jobs are offering around 70k on the Glassdoor. I'd like to find out what predictors influence the income the most. 


```{r}
ggplot(data=all_jobs, aes(x=median)) +
  geom_histogram(fill="white", color="black",bins=30) +
  labs(x = "Median expected income in thousands") 

```

First of all, I would like to find the relationship between the programming skills, such as R, Python, SQL, etc., and the median income posted by  In the following graph, I am showing the rating of the company in relation to the predictive median income of the job posts for companies in different sizes and revenues. And 


```{r}
ggplot(data=all_jobs, aes(x=python,y=median)) +
  geom_point() +
  stat_smooth(method="lm", fullrange=TRUE) +
  xlab("Rating") + ylab("median for expected income") + 
  facet_wrap( ~ Size) +
  theme(axis.title=element_text(size=16),
        axis.text=element_text(size=14),
        strip.text=element_text(size=14))
```

I would like to get the relationship between the continuous predictor, rating of the companies, and predictive income. There are mutiple classifications on jobs provided by different companies. For example, the location of the job, the sector of the job, and the even companies' sizes and revenues. All of these classifications can be incorporated into the multilevel regression model. In the following graph, I am showing the rating of the company in relation to the predictive median income of the job posts for companies in different sizes and revenues. 

```{r}
ggplot(data = all_jobs) + 
  aes(x = log(Rating+1), y = log(median)) + 
  geom_point(aes(color = factor(Revenue)), size = .6) + 
  geom_smooth(aes(color = factor(Revenue)), method = "lm", se = FALSE, formula = 'y ~ x') + 
  labs(title = "(a) Salary vs Rating", x = "log(average Rating)", y = "log(Salary)")
```

```{r}
ggplot(data = all_jobs) + 
  aes(x = log(Rating+1), y = log(median)) + 
  geom_point(aes(color = factor(Size)), size = .6) + 
  geom_smooth(aes(color = factor(Size)), method = "lm", se = FALSE, formula = 'y ~ x') + 
  labs(title = "(a) Salary vs Rating", x = "log(average Rating)", y = "log(Salary)")
```

```{r}
library(gridExtra)

python_graph <- ggplot(data = all_jobs) + 
  aes(x = python, y = log(median)) + 
  geom_point(aes(color = factor(Size)), size = .6) + 
  geom_smooth(aes(color = factor(Size)), method = "lm", se = FALSE, formula = 'y ~ x') + 
  labs(title = "(a) Salary vs Python", x = "Requred python or not", y = "log(Salary)")

r_graph <- ggplot(data = all_jobs) + 
  aes(x = R, y = log(median)) + 
  geom_point(aes(color = factor(Size)), size = .6) + 
  geom_smooth(aes(color = factor(Size)), method = "lm", se = FALSE, formula = 'y ~ x') + 
  labs(title = "(a) Salary vs R", x = "Requred R or not", y = "log(Salary)")

spark_graph <- ggplot(data = all_jobs) + 
  aes(x = spark, y = log(median)) + 
  geom_point(aes(color = factor(Size)), size = .6) + 
  geom_smooth(aes(color = factor(Size)), method = "lm", se = FALSE, formula = 'y ~ x') + 
  labs(title = "(a) Salary vs spark", x = "Requred spark or not", y = "log(Salary)")

aws_graph <- ggplot(data = all_jobs) + 
  aes(x = aws, y = log(median)) + 
  geom_point(aes(color = factor(Size)), size = .6) + 
  geom_smooth(aes(color = factor(Size)), method = "lm", se = FALSE, formula = 'y ~ x') + 
  labs(title = "(a) Salary vs AWS skill", x = "Requred AWS or not", y = "log(Salary)")


grid.arrange(python_graph, r_graph, spark_graph, aws_graph, ncol=2)
```

```{r}
sql_graph <- ggplot(data = all_jobs) + 
  aes(x = sql, y = log(median)) + 
  geom_point(aes(color = factor(Size)), size = .6) + 
  geom_smooth(aes(color = factor(Size)), method = "lm", se = FALSE, formula = 'y ~ x') + 
  labs(title = "(a) Salary vs SQL", x = "Requred SQL or not", y = "log(Salary)")

excel_graph <- ggplot(data = all_jobs) + 
  aes(x = excel, y = log(median)) + 
  geom_point(aes(color = factor(Size)), size = .6) + 
  geom_smooth(aes(color = factor(Size)), method = "lm", se = FALSE, formula = 'y ~ x') + 
  labs(title = "(a) Salary vs Excel skill", x = "Requred Excel or not", y = "log(Salary)")


grid.arrange(sql_graph, excel_graph, ncol=2)
```

```{r}
log_jobs <- all_jobs %>% dplyr::select(Company.Name, Location, Headquarters,Job.Title, Size, Industry,Sector, Revenue, median, Rating, R, python, aws, spark, sql, excel) %>% data.frame()

log_jobs$Company.Name <- as.factor(log_jobs$Company.Name)
log_jobs$Location <- factor(log_jobs$Location)
log_jobs$Headquarters <- factor(log_jobs$Headquarters)
log_jobs$Job.Title <- as.factor(log_jobs$Job.Title)
log_jobs$Size <- factor(log_jobs$Size)
log_jobs$Industry <- factor(log_jobs$Industry)
log_jobs$Sector <- factor(log_jobs$Sector)
log_jobs$Revenue <- factor(log_jobs$Revenue)
log_jobs$median <- log(log_jobs$median + 1)
log_jobs$Rating <- log(log_jobs$Rating + 2)

```

```{r}
library(lattice)
fit1 <- lmerTest::lmer(median ~ Rating + R + python + aws + sql + spark + excel + (1|Job.Title) +(1|Industry) + (1|Headquarters), data=log_jobs)
summary(fit1)
plot(fit1)
plot(ranef(fit1))
qqmath(fit1)

RandomEffects1 <- as.data.frame(VarCorr(fit1))
ICC_between1 <- RandomEffects1[1,4]/(RandomEffects1[1,4]+RandomEffects1[3,4]) 
RandomEffects1
ICC_between1

fit2 <- lmerTest::lmer(median ~ (R + python + aws + sql + spark + excel + (1 | Size) + (1 | Revenue))^3, data=all_jobs)
summary(fit2)
plot(fit2)
```

```{r}
qqnorm(residuals(fit1))

```


## job cleaning

```{r}
## clean the string estimated salary column
job %<>% separate(Salary.Estimate, c("bottom", "top"), sep = "-")
regexp <- "[[:digit:]]+"
job %<>% mutate(bottom = as.numeric(str_extract(bottom, regexp)))
job %<>% mutate(top = as.numeric(str_extract(top, regexp)))
job %<>% mutate(median=(bottom+top)/2, .before=top)
```

## eda

```{r}
ggplot(data = job) + 
  aes(x = log(Rating), y = log(median)) + 
  geom_point(aes(color = factor(Revenue)), size = .6) + 
  geom_smooth(aes(color = factor(Revenue)), method = "lm", se = FALSE, formula = 'y ~ x') + 
  labs(title = "(a) Salary vs Rating", x = "log(average Rating)", y = "log(Salary)")
```

```{r}
ggplot(data = job) + 
  aes(x = log(Rating), y = log(median)) + 
  geom_point(aes(color = factor(Size)), size = .6) + 
  geom_smooth(aes(color = factor(Size)), method = "lm", se = FALSE, formula = 'y ~ x') + 
  labs(title = "(a) Salary vs Rating", x = "log(average Rating)", y = "log(Salary)")
```

```{r}
ggplot(data = job) + 
  aes(x = python_yn, y = log(median)) + 
  geom_point(aes(color = factor(Size)), size = .6) + 
  geom_smooth(aes(color = factor(Size)), method = "lm", se = FALSE, formula = 'y ~ x') + 
  labs(title = "(a) Salary vs Rating", x = "Requred python or not", y = "log(Salary)")
```

```{r}
ggplot(data = job) + 
  aes(x = python_yn, y = log(median)) + 
  geom_point(aes(color = factor(Size)), size = .6) + 
  geom_smooth(aes(color = factor(Size)), method = "lm", se = FALSE, formula = 'y ~ x') + 
  labs(title = "(a) Salary vs Rating", x = "Requred python or not", y = "log(Salary)")
```
